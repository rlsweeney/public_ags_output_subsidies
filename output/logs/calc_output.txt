------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  D:\GitDir\Projects\ags_capital_vs_output/output/logs/calc_output.txt
  log type:  text
 opened on:  13 Jul 2022, 06:45:07

. ********************************************************************************
. global wind_data "D:/Dropbox/data/wind_speed_data"  

. global wind_temp "$repodir/temp"

. ********************************************************************************
. 
. **************************************************
. * CREATE A DATASET WITH JUST REFERENCE POWERCURVE
. **************************************************
. use "$generated_data/models_powercurve_xwalk.dta", clear

. keep if powercurve_turbinemodel == "1.5sle"
(730 observations deleted)

. keep powercurve_turbinemodel w*

. duplicates drop

Duplicates in terms of all variables

(228 observations deleted)

. renvars w*, prefix("ref")

. *note this renvars command no longer used. see here https://www.statalist.org/forums/for
> um/general-stata-discussion/general/1560780-renvars-command
. *the following should work 
. *rename (w*) ref=
. tempfile reference_powercurve

. save "`reference_powercurve'"
file C:\Users\Rich\AppData\Local\Temp\ST_4840_000001.tmp saved

. 
. ************************
. * CALCULATE OUTPUT
. ************************
. cd "$wind_data"
D:\Dropbox\data\wind_speed_data

. local wind_files: dir "wind_clean" files "wind_*.dta"

. local counter = 0

. foreach w_file in `wind_files' {
  2.         qui {
  3.                 use "wind_clean/`w_file'", clear
  4.                 
.                 * Bring in powercurve for each facility
.                 merge m:1 facilityid using "$generated_data/models_powercurve_xwalk.dta"
> , keep(master matched) nogen
  5.                 
.                 **************************************
.                 * CALC OUTPUT USING MATCHED POWERCURVE
.                 **************************************
.                 gen output = 0
  6.                 * Multiplying by 2 because w30 corresponds to 15 miles per hour. 
.                 * So if wind is 15.32 becomes 30 so then output for w30 gets selected
.                 gen wind = round(windspeed_80m * 2)
  7.                 
.                 forval i = 0 / 60 {
  8.                         replace output = w`i' if wind == `i'
  9.                 }
 10.                 gen output_adjusted  = (pressure_0m / temperature_2m) / (101325 / 288
> .15) * output
 11.                 
.                 *****************************************************
.                 * CALC REFERENCE OUTPUT (OUTPUT USING MODAL TURBINE)
.                 *****************************************************
.                 
.                 * Regular output for unmatched turbines was using modal turbine. Dont' n
> eed to calc again
.                 if flag_powercurve == 0 | powercurve_turbinemodel == "1.5sle" {
 12.                         gen output_refturb = output
 13.                         gen output_refturb_adjusted = output_adjusted
 14.                 }
 15. 
.                 * FOR MATCHED FACILITIES, GOING TO BRING IN MODAL POWERCURVE AND CALCULA
> TE OUTPUT
.                 else {
 16.                         cross using "`reference_powercurve'"
 17.                         gen output_refturb = 0
 18.                         forval i = 0 / 60 {
 19.                                 replace output_refturb = refw`i' if wind == `i'
 20.                         }
 21.                         gen output_refturb_adjusted = (pressure_0m / temperature_2m) 
> / (101325 / 288.15) * output_refturb
 22.                 }
 23.                 collapse (sum) output*, by(facilityid year month)
 24.                 
.                 compress
 25.                 local counter = `counter' + 1
 26.                 tempfile output`counter'
 27.                 save "`output`counter''"
 28.         }
 29. }

. clear

. forval y = 1 / `counter' {
  2.         append using "`output`y''"
  3. }
(note: variable facilityid was int, now long to accommodate using data's values)
(note: variable output was long, now double to accommodate using data's values)

. foreach var in output output_adjusted output_refturb output_refturb_adjusted {
  2.         replace `var' = `var' / 1000
  3. }
(139,473 real changes made)
(139,473 real changes made)
variable output_refturb was long now double
(139,489 real changes made)
(139,489 real changes made)

. gen reference_turbine_capacity = 1.5

. label var output "Monthly output (MWH)"

. label var output_adjusted "Monthly output (MWH) adjusted for temp and pressure"

. label var output_refturb "Monthly output using the modal turbine"

. label var output_refturb_adjusted "Monthly output using modal turbine adj for temp and p
> ressure"

. save "$generated_data/calculated_output.dta", replace
(note: file D:\GitDir\Projects\ags_capital_vs_output/generated_data/calculated_output.dta 
> not found)
file D:\GitDir\Projects\ags_capital_vs_output/generated_data/calculated_output.dta saved

. ********************************************************************************
. tempsetup
D:\GitDir\Projects\ags_capital_vs_output\temp

. capture log close
